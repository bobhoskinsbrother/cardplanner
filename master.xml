<project name="CardPlannerStandaloneApplication" default="CardPlannerStandaloneApplication">

    <import file="common.xml" />
    <property file="environments/${computer.hostname}.properties" />
    <property file="CardPlanner/build.properties" />
    <property file="build.properties" />
	<import file="${cardplanner.website.directory}/war.xml" />
	<import file="${cardplanner.website.functional.directory}/build.xml" />

	<target name="CardPlannerStandaloneApplication" depends="standalone.cardplanner.website.make,standalone.cardplanner.website.test" />

	<target name="standalone.cardplanner.website.make">
		<antcall target="WarCardPlanner.WarCardPlanner" />
        <antcall target="standalone.cardplanner.website.make.zip"/>
	</target>

    <target name="standalone.cardplanner.website.test" unless="fudgeIt">
        <antcall target="unzip.webapp" />
        <antcall target="start.jetty" />
        <antcall target="CardPlannerFunctionalTests.CardPlannerFunctionalTests" />
    </target>

	<target name="standalone.cardplanner.website.make.zip">
		<zip destfile="${cardplanner.server.standalone.dist.directory}/${cardplanner.server.standalone}.zip">
			<zipfileset dir="${cardplanner.server.standalone.directory}/sh" prefix="${cardplanner.server.standalone}" includes="**/*" />
			<zipfileset file="${cardplanner.website.dist.directory}/${instance.war}" prefix="${cardplanner.server.standalone}/lib"/>
			<zipfileset file="${yawf.dist.directory}/${yawf.jar}" prefix="${cardplanner.server.standalone}/lib" />

			<zipfileset file="${servlet-api.jar}" prefix="${cardplanner.server.standalone}/lib" />
			<zipfileset file="${jetty-server.jar}" prefix="${cardplanner.server.standalone}/lib" />
			<zipfileset file="${jetty-servlet.jar}" prefix="${cardplanner.server.standalone}/lib" />
			<zipfileset file="${jetty-http.jar}" prefix="${cardplanner.server.standalone}/lib" />
			<zipfileset file="${jetty-webapp.jar}" prefix="${cardplanner.server.standalone}/lib" />
			<zipfileset file="${jetty-util.jar}" prefix="${cardplanner.server.standalone}/lib" />
			<zipfileset file="${jetty-io.jar}" prefix="${cardplanner.server.standalone}/lib" />
			<zipfileset file="${jetty-security.jar}" prefix="${cardplanner.server.standalone}/lib" />
			<zipfileset file="${jetty-xml.jar}" prefix="${cardplanner.server.standalone}/lib" />
			<zipfileset file="${jetty-plus.jar}" prefix="${cardplanner.server.standalone}/lib" />
			<zipfileset file="${jetty-jndi.jar}" prefix="${cardplanner.server.standalone}/lib" />
			<zipfileset file="${jetty-continuation.jar}" prefix="${cardplanner.server.standalone}/lib" />
		</zip>
	</target>

    <target name="unzip.webapp">
        <init.dir dir="${cardplanner.server.standalone.directory}/tmp-test-dir" />
        <unzip src="${cardplanner.server.standalone.dist.directory}/${cardplanner.server.standalone}.zip" dest="${cardplanner.server.standalone.directory}/tmp-test-dir" />
    </target>

    <target name="start.jetty">
        <exec osfamily="windows" dir="${cardplanner.server.standalone.directory}/tmp-test-dir/${cardplanner.server.standalone}" executable="cmd">
            <arg value="./start_cardplanner.bat" />
        </exec>
        <exec osfamily="unix" dir="${cardplanner.server.standalone.directory}/tmp-test-dir/${cardplanner.server.standalone}" executable="sh">
            <arg value="./start_cardplanner.sh" />
            <arg value="&amp;"/>
        </exec>
    </target>

</project>